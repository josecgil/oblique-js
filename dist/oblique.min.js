(function(){var ClassDSL,DataModelDSL,DirectiveCollection,DirectiveProcessor,Element,Error,ModelDSL,ModelDSLPart,Oblique,ObliqueError,Template,TemplateFactory,TimedDOMObserver,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};this.ObliqueNS=this.ObliqueNS||{},ModelDSLPart=function(){function ModelDSLPart(part){var firstBracePosition,indexStr,lastBracePosition;this.name=part,this.hasIndex=!1,this.index=void 0,firstBracePosition=part.indexOf("["),-1!==firstBracePosition&&(this.hasIndex=!0,this.name=part.substr(0,firstBracePosition),lastBracePosition=part.indexOf("]"),indexStr=part.slice(firstBracePosition+1,lastBracePosition),this.index=parseInt(indexStr,10))}return ModelDSLPart}(),ModelDSL=function(){function ModelDSL(_expression){var part,_i,_len,_ref;if(this._expression=_expression,this.hasFullModel=!1,this._partsByDot=this._expression.split("."),this._checkSyntax(),this._partsByDot.shift(),0===this._partsByDot.length)return this.hasFullModel=!0,void(this.properties=void 0);for(this.properties=[],_ref=this._partsByDot,_i=0,_len=_ref.length;_len>_i;_i++)part=_ref[_i],this.properties.push(new ModelDSLPart(part))}return ModelDSL.prototype._checkSyntax=function(){var lastIndex;if("Model"!==this._partsByDot[0])throw new ObliqueNS.Error("data-model must begins with 'Model or new'");if(lastIndex=this._partsByDot.length-1,""===this._partsByDot[lastIndex])throw new ObliqueNS.Error("data-model needs property after dot")},ModelDSL}(),ClassDSL=function(){function ClassDSL(_expression){var classNameAndBrackets,closeBracket,openBracket;if(this._expression=_expression,classNameAndBrackets=this._expression.split(" ")[1],openBracket=classNameAndBrackets.indexOf("("),-1===openBracket)throw new ObliqueNS.Error("data-model needs open bracket after className");if(closeBracket=classNameAndBrackets.indexOf(")",openBracket),-1===closeBracket)throw new ObliqueNS.Error("data-model needs close bracket after className");this.name=classNameAndBrackets.slice(0,openBracket)}return ClassDSL}(),DataModelDSL=function(){function DataModelDSL(_expression){var modelDSL,modelExpression;this._expression=_expression,this._checkIsNullOrEmpty(),this._expression=this._removeExtraSpaces(this._expression),this.hasFullModel=!1,this.modelProperties=void 0,this.className=void 0,this._hasClass="new"===this._expression.split(" ")[0],this._hasClass&&(this.className=new ClassDSL(this._expression).name),modelExpression=this._extractModelExpression(),""!==modelExpression&&(modelDSL=new ModelDSL(modelExpression),this.modelProperties=modelDSL.properties,this.hasFullModel=modelDSL.hasFullModel)}return DataModelDSL.prototype._removeExtraSpaces=function(str){for(;-1!==str.indexOf("  ");)str=str.replace("  "," ");return str=str.trim(),str=str.replace(" (","("),str=str.replace(" )",")"),str=str.replace("( ","("),str=str.replace(") ",")")},DataModelDSL.prototype._extractModelExpression=function(){var modelFirstPosition,modelLastPosition;return this._hasClass?(modelFirstPosition=this._expression.indexOf("(Model"),-1===modelFirstPosition?"":(modelLastPosition=this._expression.indexOf(")"),this._expression.slice(modelFirstPosition+1,modelLastPosition))):this._expression},DataModelDSL.prototype._checkIsNullOrEmpty=function(){if(this._isNullOrEmpty())throw new ObliqueNS.Error("data-model can't be null or empty")},DataModelDSL.prototype._isNullOrEmpty=function(){return void 0===this._expression?!0:null===this._expression?!0:""===this._expression?!0:!1},DataModelDSL}(),ObliqueNS.DataModelDSL=DataModelDSL,this.ObliqueNS=this.ObliqueNS||{},DirectiveCollection=function(){function DirectiveCollection(){this.directives=[],this._directivesByName={}}return DirectiveCollection.prototype.count=function(){return this.directives.length},DirectiveCollection.prototype._isAFunction=function(memberToTest){return"function"==typeof memberToTest},DirectiveCollection.NOT_A_FUNCTION_CLASS_ERROR_MESSAGE="registerDirective must be called with a Directive 'Constructor/Class'",DirectiveCollection.prototype._throwErrorIfDirectiveIsNotValid=function(directiveName,directive){if(!directiveName||"string"!=typeof directiveName)throw new ObliqueNS.Error("registerDirective must be called with a string directiveName");if(!this._isAFunction(directive))throw new ObliqueNS.Error(ObliqueNS.DirectiveCollection.NOT_A_FUNCTION_CLASS_ERROR_MESSAGE)},DirectiveCollection.prototype.add=function(directiveName,directiveFn){return this._throwErrorIfDirectiveIsNotValid(directiveName,directiveFn),this.directives.push(directiveFn),this._directivesByName[directiveName]=directiveFn},DirectiveCollection.prototype.at=function(index){return this.directives[index]},DirectiveCollection.prototype.getDirectiveByName=function(directiveName){return this._directivesByName[directiveName]},DirectiveCollection}(),ObliqueNS.DirectiveCollection=DirectiveCollection,this.ObliqueNS=this.ObliqueNS||{},DirectiveProcessor=function(){function DirectiveProcessor(){return this===window?new DirectiveProcessor:DirectiveProcessor._singletonInstance?DirectiveProcessor._singletonInstance:(DirectiveProcessor._singletonInstance=this,this._throwErrorIfJQueryIsntLoaded(),this._directiveCollection=new ObliqueNS.DirectiveCollection,this._timedDOMObserver=this._createTimedDOMObserver(DirectiveProcessor.DEFAULT_INTERVAL_MS),void jQuery(document).ready(function(_this){return function(){return _this._applyDirectivesInDOM(),_this._timedDOMObserver.observe()}}(this)))}return DirectiveProcessor.DEFAULT_INTERVAL_MS=500,DirectiveProcessor.prototype._throwErrorIfJQueryIsntLoaded=function(){if(!window.jQuery)throw new Error("DirectiveProcessor needs jQuery to work")},DirectiveProcessor.prototype._createTimedDOMObserver=function(intervalInMs){var observer;return observer=new ObliqueNS.TimedDOMObserver(intervalInMs),observer.onChange(function(_this){return function(){return _this._applyDirectivesInDOM()}}(this)),observer},DirectiveProcessor._isApplyingDirectivesInDOM=!1,DirectiveProcessor.prototype._applyDirectivesInDOM=function(){var body,rootObElement;if(!this._isApplyingDirectivesInDOM){this._isApplyingDirectivesInDOM=!0;try{return body=document.getElementsByTagName("body")[0],rootObElement=new ObliqueNS.Element(body),rootObElement.eachDescendant(function(_this){return function(DOMElement){var directiveAttrValue,obElement;return obElement=new ObliqueNS.Element(DOMElement),directiveAttrValue=obElement.getAttributeValue("data-directive"),directiveAttrValue?_this._processDirectiveElement(obElement,directiveAttrValue):void 0}}(this))}finally{this._isApplyingDirectivesInDOM=!1}}},DirectiveProcessor.prototype._processDirectiveElement=function(obElement,directiveAttrValue){var directive,directiveData,directiveName,model,params,_i,_len,_ref,_results;for(_ref=directiveAttrValue.split(","),_results=[],_i=0,_len=_ref.length;_len>_i;_i++)if(directiveName=_ref[_i],directiveName=directiveName.trim(),!obElement.hasFlag(directiveName)){if(directive=this._directiveCollection.getDirectiveByName(directiveName),!directive)throw new ObliqueNS.Error("There is no "+directiveName+" directive registered");obElement.setFlag(directiveName),model=this._getModel(obElement),params=this._getParams(obElement),directiveData={domElement:obElement.getDOMElement(),jQueryElement:obElement.getjQueryElement(),model:model,params:params},_results.push(new directive(directiveData))}return _results},DirectiveProcessor.prototype._getParams=function(obElement){var dataParamsExpr,e;if(dataParamsExpr=obElement.getAttributeValue("data-params"),!dataParamsExpr)return void 0;try{return jQuery.parseJSON(dataParamsExpr)}catch(_error){return e=_error,this._throwError(""+obElement.getHtml()+": data-params parse error: "+e.message)}},DirectiveProcessor.prototype._getModel=function(obElement){var className,constructorFn,dataModelDSL,dataModelExpr,model,property,_i,_len,_ref;if(model=Oblique().getModel(),dataModelExpr=obElement.getAttributeValue("data-model"),void 0===dataModelExpr)return void 0;if(dataModelDSL=new ObliqueNS.DataModelDSL(dataModelExpr),!dataModelDSL.hasFullModel&&dataModelDSL.modelProperties)for(_ref=dataModelDSL.modelProperties,_i=0,_len=_ref.length;_len>_i;_i++)property=_ref[_i],model.hasOwnProperty(property.name)||this._throwError(""+obElement.getHtml()+": data-model doesn't match any data in model"),model=model[property.name],property.hasIndex&&(model=model[property.index]);return className=dataModelDSL.className,className&&(window.hasOwnProperty(className)||this._throwError(""+obElement.getHtml()+": '"+className+"' isn't an existing class in data-model"),constructorFn=window[className],model=new constructorFn(model)),model},DirectiveProcessor.prototype._throwError=function(errorMessage){return Oblique().triggerOnError(new ObliqueNS.Error(errorMessage))},DirectiveProcessor.prototype.getIntervalTimeInMs=function(){return this._timedDOMObserver.getIntervalInMs()},DirectiveProcessor.prototype.setIntervalTimeInMs=function(newIntervalTimeInMs){if(0>=newIntervalTimeInMs)throw new ObliqueNS.Error("IntervalTime must be a positive number");return this._timedDOMObserver.destroy(),this._timedDOMObserver=this._createTimedDOMObserver(newIntervalTimeInMs),this._timedDOMObserver.observe()},DirectiveProcessor.prototype.registerDirective=function(directiveName,directiveConstructorFn){return this._directiveCollection.add(directiveName,directiveConstructorFn)},DirectiveProcessor.prototype.destroy=function(){return this._timedDOMObserver.destroy(),DirectiveProcessor._singletonInstance=void 0},DirectiveProcessor}(),ObliqueNS.DirectiveProcessor=DirectiveProcessor,this.Oblique=DirectiveProcessor,this.ObliqueNS=this.ObliqueNS||{},Element=function(){function Element(DOMElement){this._jQueryElement=jQuery(DOMElement)}return Element.prototype.getDOMElement=function(){return this._jQueryElement.get(0)},Element.prototype.getjQueryElement=function(){return this._jQueryElement},Element.prototype.isTag=function(){return Element._isTag(this._DOMElement)},Element.prototype.matchCSSExpression=function(cssExpression){return this._jQueryElement.is(cssExpression)},Element.prototype.setFlag=function(flagName){return this._jQueryElement.data(flagName,!0)},Element.prototype.unsetFlag=function(flagName){return this._jQueryElement.removeData(flagName)},Element.prototype.hasFlag=function(flagName){return this._jQueryElement.data(flagName)},Element.prototype.hasAttribute=function(attributeName){var attrValue;return attrValue=this.getAttributeValue(attributeName),void 0===attrValue?!1:!0},Element.prototype.getAttributeValue=function(attributeName){return this._jQueryElement.attr(attributeName)},Element.prototype.eachDescendant=function(callbackOnDOMElement){return Element._traverse(this.getDOMElement(),callbackOnDOMElement)},Element._isTag=function(DOMElement){return 1===DOMElement.nodeType},Element._traverse=function(parentElement,callbackOnDOMElement){var child,currentElement,elementsToTraverse,_results;for(elementsToTraverse=[],Element._isTag(parentElement)&&elementsToTraverse.push(parentElement),callbackOnDOMElement(parentElement),_results=[];elementsToTraverse.length>0;)currentElement=elementsToTraverse.pop(),_results.push(function(){var _i,_len,_ref,_results1;for(_ref=currentElement.children,_results1=[],_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],Element._isTag(child)?(elementsToTraverse.push(child),_results1.push(callbackOnDOMElement(child))):_results1.push(void 0);return _results1}());return _results},Element.prototype.getHtml=function(){return this.getDOMElement().outerHTML},Element}(),ObliqueNS.Element=Element,this.ObliqueNS=this.ObliqueNS||{},Error=function(){function Error(message){return this.message=message,this===window?new Error(this.message):void(this.name="Oblique.Error")}return Error}(),ObliqueNS.Error=Error,this.ObliqueNS=this.ObliqueNS||{},Oblique=function(){function Oblique(){return this===window?new Oblique:Oblique._singletonInstance?Oblique._singletonInstance:(Oblique._singletonInstance=this,this.directiveProcessor=new ObliqueNS.DirectiveProcessor,this.templateFactory=new ObliqueNS.TemplateFactory,void(this._onErrorCallbacks=[]))}return Oblique.DEFAULT_INTERVAL_MS=500,Oblique.prototype.getIntervalTimeInMs=function(){return this.directiveProcessor.getIntervalTimeInMs()},Oblique.prototype.setIntervalTimeInMs=function(newIntervalTimeInMs){return this.directiveProcessor.setIntervalTimeInMs(newIntervalTimeInMs)},Oblique.prototype.registerDirective=function(directiveName,directiveConstructorFn){return this.directiveProcessor.registerDirective(directiveName,directiveConstructorFn)},Oblique.prototype.destroy=function(){var e;this.directiveProcessor.destroy();try{return delete Oblique._singletonInstance}catch(_error){return e=_error,Oblique._singletonInstance=void 0}},Oblique.prototype.setModel=function(_model){this._model=_model},Oblique.prototype.getModel=function(){return this._model},Oblique.prototype.hasModel=function(){return this._model?!0:!1},Oblique.prototype.renderHtml=function(url,model){var template;if(void 0===Handlebars)throw new ObliqueNS.Error("Oblique().renderHtml() needs handlebarsjs loaded to work");return template=this.templateFactory.createFromUrl(url),template.renderHTML(model)},Oblique.prototype.onError=function(onErrorCallback){return this._onErrorCallbacks.push(onErrorCallback)},Oblique.prototype.triggerOnError=function(error){var callback,_i,_len,_ref;for(_ref=this._onErrorCallbacks,_i=0,_len=_ref.length;_len>_i;_i++)(callback=_ref[_i])(error);throw error},Oblique}(),ObliqueNS.Oblique=Oblique,this.Oblique=Oblique,this.ObliqueNS=this.ObliqueNS||{},ObliqueError=function(_super){function ObliqueError(message){return this.message=message,this===window?new Error(this.message):void(this.name="ObliqueNS.Error")}return __extends(ObliqueError,_super),ObliqueError}(Error),ObliqueNS.Error=ObliqueError,this.ObliqueNS=this.ObliqueNS||{},Template=function(){function Template(templateContent){this.compiledTemplate=Handlebars.compile(templateContent)}return Template.prototype.renderHTML=function(model){return this.compiledTemplate(model)},Template}(),ObliqueNS.Template=Template,this.ObliqueNS=this.ObliqueNS||{},TemplateFactory=function(){function TemplateFactory(){}return Template=ObliqueNS.Template,TemplateFactory.prototype.createFromString=function(templateStr){return new Template(templateStr)},TemplateFactory.prototype.createFromDOMElement=function(element){return this.createFromString($(element).html())},TemplateFactory.prototype.createFromUrl=function(url){var errorMessage,errorStatusCode,template,templateContent;if(templateContent=void 0,errorStatusCode=200,errorMessage=void 0,jQuery.ajax({url:url,success:function(data){return templateContent=data},error:function(e){return errorStatusCode=e.status,errorMessage=e.statusCode},async:!1}),404===errorStatusCode)throw new ObliqueNS.Error("template '"+url+"' not found");if(200!==errorStatusCode)throw new ObliqueNS.Error(errorMessage);return template=this.createFromString(templateContent)},TemplateFactory}(),ObliqueNS.TemplateFactory=TemplateFactory,this.ObliqueNS=this.ObliqueNS||{},TimedDOMObserver=function(){function TimedDOMObserver(intervalInMs){this.intervalInMs=intervalInMs,this._intervalId=void 0,this._callback=function(){}}return TimedDOMObserver.prototype.onChange=function(callback){return this._callback=callback},TimedDOMObserver.prototype.getIntervalInMs=function(){return this.intervalInMs},TimedDOMObserver.prototype.observe=function(){return this._intervalId=setInterval(function(_this){return function(){return _this._callback()}}(this),this.intervalInMs)},TimedDOMObserver.prototype.destroy=function(){return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0},TimedDOMObserver}(),ObliqueNS.TimedDOMObserver=TimedDOMObserver}).call(this);